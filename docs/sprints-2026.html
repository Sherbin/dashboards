<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sprint Calendar 2026</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    * { box-sizing: border-box; }
    body { margin: 0; padding: 0; }

    /* CSS Custom Properties for instant theme switching */
    /* Dark theme matches Confluence dark: #1F1F21 */
    :root {
      --bg: #1F1F21;
      --card-bg: rgba(255,255,255,0.05);
      --card-border: rgba(255,255,255,0.1);
      --text: #F2F2F2;
      --text-muted: #8C8C8C;
      --text-dim: #636363;
      --hover-bg: rgba(255,255,255,0.1);
      --progress-bg: rgba(255,255,255,0.1);
      --ring-offset: #1F1F21;
      --non-sprint-bg: rgba(255,255,255,0.15);
      --weekend-bg: rgba(255,255,255,0.08);
      --past-day-bg: #3D3D3D;
      --calendar-bg: #1F1F21;
    }

    /* Light theme matches Confluence light: #FFF */
    :root.light {
      --bg: #FFFFFF;
      --card-bg: rgba(0,0,0,0.03);
      --card-border: rgba(0,0,0,0.08);
      --text: #0F0F0F;
      --text-muted: #636363;
      --text-dim: #9C9C9C;
      --hover-bg: rgba(0,0,0,0.05);
      --progress-bg: rgba(0,0,0,0.08);
      --ring-offset: #FFFFFF;
      --non-sprint-bg: rgba(0,0,0,0.12);
      --weekend-bg: rgba(0,0,0,0.06);
      --past-day-bg: #D0D0D0;
      --calendar-bg: #FFFFFF;
    }

    /* Today's date highlight */
    .today-cell {
      box-shadow: 0 0 0 2px var(--text), 0 4px 8px rgba(0, 0, 0, 0.4) !important;
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState, useMemo, useEffect, Fragment } = React;

    const sprintData = [
      { sprint: "26Q1S1", start: "2026-01-05", end: "2026-01-16", quarter: "Q1" },
      { sprint: "26Q1S2", start: "2026-01-19", end: "2026-01-30", quarter: "Q1" },
      { sprint: "26Q1S3", start: "2026-02-02", end: "2026-02-13", quarter: "Q1" },
      { sprint: "26Q1S4", start: "2026-02-16", end: "2026-02-27", quarter: "Q1" },
      { sprint: "26Q1S5", start: "2026-03-02", end: "2026-03-13", quarter: "Q1" },
      { sprint: "26Q1S6", start: "2026-03-16", end: "2026-03-27", quarter: "Q1" },
      { sprint: "26Q2S1", start: "2026-03-30", end: "2026-04-10", quarter: "Q2" },
      { sprint: "26Q2S2", start: "2026-04-13", end: "2026-04-24", quarter: "Q2" },
      { sprint: "26Q2S3", start: "2026-04-27", end: "2026-05-08", quarter: "Q2" },
      { sprint: "26Q2S4", start: "2026-05-11", end: "2026-05-22", quarter: "Q2" },
      { sprint: "26Q2S5", start: "2026-05-25", end: "2026-06-05", quarter: "Q2" },
      { sprint: "26Q2S6", start: "2026-06-08", end: "2026-06-19", quarter: "Q2" },
      { sprint: "26Q2S7", start: "2026-06-22", end: "2026-07-03", quarter: "Q2" },
      { sprint: "26Q3S1", start: "2026-07-06", end: "2026-07-17", quarter: "Q3" },
      { sprint: "26Q3S2", start: "2026-07-20", end: "2026-07-31", quarter: "Q3" },
      { sprint: "26Q3S3", start: "2026-08-03", end: "2026-08-14", quarter: "Q3" },
      { sprint: "26Q3S4", start: "2026-08-17", end: "2026-08-28", quarter: "Q3" },
      { sprint: "26Q3S5", start: "2026-08-31", end: "2026-09-11", quarter: "Q3" },
      { sprint: "26Q3S6", start: "2026-09-14", end: "2026-09-25", quarter: "Q3" },
      { sprint: "26Q4S1", start: "2026-09-28", end: "2026-10-09", quarter: "Q4" },
      { sprint: "26Q4S2", start: "2026-10-12", end: "2026-10-23", quarter: "Q4" },
      { sprint: "26Q4S3", start: "2026-10-26", end: "2026-11-06", quarter: "Q4" },
      { sprint: "26Q4S4", start: "2026-11-09", end: "2026-11-20", quarter: "Q4" },
      { sprint: "26Q4S5", start: "2026-11-23", end: "2026-12-04", quarter: "Q4" },
      { sprint: "26Q4S6", start: "2026-12-07", end: "2026-12-18", quarter: "Q4" },
      { sprint: "26Q4S7", start: "2026-12-21", end: "2026-12-31", quarter: "Q4" },
    ];

    // 7 shades per quarter from palette-colors.json (levels 200→800), light→dark
    const quarterColors = {
      Q1: {
        shades: ["#90BFF9", "#5B9CF6", "#3179F5", "#2962FF", "#1E53E5", "#1848CC", "#143EB2"],
        current: "#0C3299",
        border: "#143EB2",
        label: "Q1",
        full: "Q1"
      },
      Q2: {
        shades: ["#70CC9E", "#42BD7F", "#22AB67", "#089950", "#068043", "#056636", "#004D27"],
        current: "#1A3326",
        border: "#004D27",
        label: "Q2",
        full: "Q2"
      },
      Q3: {
        shades: ["#FFCC80", "#ffb74d", "#FFA726", "#FF9800", "#FB8C00", "#F57C00", "#EF6C00"],
        current: "#e65100",
        border: "#F57C00",
        label: "Q3",
        full: "Q3"
      },
      Q4: {
        shades: ["#f48fb1", "#f06292", "#ec407a", "#e91e63", "#D81B60", "#C2185B", "#AD1457"],
        current: "#880E4F",
        border: "#AD1457",
        label: "Q4",
        full: "Q4"
      },
      none: {
        shades: ["#4A4A4A"],
        current: "#3D3D3D",
        border: "#2E2E2E",
        label: "",
        full: "Out of Sprint"
      }
    };

    // Public holidays by office (only "Red" days from holidays.json)
    // CY = Cyprus (Limassol), GE = Georgia (Tbilisi), ES = Spain (Malaga), GB = Great Britain (London)
    const holidayMap = {
      "2026-01-01": { CY: true, GE: true, ES: true, GB: true },
      "2026-01-02": { GE: true },
      "2026-01-06": { CY: true, ES: true },
      "2026-01-07": { GE: true },
      "2026-01-19": { GE: true },
      "2026-02-23": { CY: true },
      "2026-02-28": { ES: true },
      "2026-03-03": { GE: true },
      "2026-03-08": { GE: true },
      "2026-03-25": { CY: true },
      "2026-04-01": { CY: true },
      "2026-04-02": { ES: true },
      "2026-04-03": { ES: true, GB: true },
      "2026-04-06": { GB: true },
      "2026-04-09": { GE: true },
      "2026-04-10": { CY: true, GE: true },
      "2026-04-13": { CY: true, GE: true },
      "2026-04-14": { CY: true },
      "2026-05-01": { CY: true, ES: true },
      "2026-05-04": { GB: true },
      "2026-05-09": { GE: true },
      "2026-05-12": { GE: true },
      "2026-05-25": { GB: true },
      "2026-05-26": { GE: true },
      "2026-06-01": { CY: true },
      "2026-06-21": { GE: true },
      "2026-08-15": { CY: true, ES: true },
      "2026-08-19": { ES: true },
      "2026-08-28": { GE: true },
      "2026-08-31": { GB: true },
      "2026-09-08": { ES: true },
      "2026-10-01": { CY: true },
      "2026-10-12": { ES: true },
      "2026-10-14": { GE: true },
      "2026-10-28": { CY: true },
      "2026-11-01": { ES: true },
      "2026-11-02": { ES: true },
      "2026-11-23": { GE: true },
      "2026-12-06": { ES: true },
      "2026-12-07": { ES: true },
      "2026-12-08": { ES: true },
      "2026-12-24": { CY: true },
      "2026-12-25": { CY: true, ES: true, GB: true },
      "2026-12-26": { CY: true },
      "2026-12-28": { GB: true },
      "2026-12-31": { CY: true, GE: true },
    };

    const allOffices = ["CY", "ES", "GB", "GE"];
    const officeLabels = { CY: "CY", GE: "GE", ES: "ES", GB: "GB" };
    const officeFlags = { CY: "\u{1F1E8}\u{1F1FE}", GE: "\u{1F1EC}\u{1F1EA}", ES: "\u{1F1EA}\u{1F1F8}", GB: "\u{1F1EC}\u{1F1E7}" };

    const months = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];

    const CELL_SIZE = 16;  // px per cell (was 12)
    const CELL_GAP = 2;    // px gap between cells (Tailwind gap-0.5)
    const CELL_STEP = CELL_SIZE + CELL_GAP; // 18px per column/row step

    function countWorkingDays(startDate, endDate) {
      let count = 0;
      const d = new Date(startDate);
      while (d <= endDate) {
        const dow = d.getUTCDay();
        if (dow !== 0 && dow !== 6) count++;
        d.setUTCDate(d.getUTCDate() + 1);
      }
      return count;
    }

    function SprintHeatmap() {
      const [hoveredDay, setHoveredDay] = useState(null);
      const [selectedSprint, setSelectedSprint] = useState(null);
      const [selectedOffices, setSelectedOffices] = useState(allOffices);

      const toggleOffice = (office) => {
        setSelectedOffices(prev => {
          const next = prev.includes(office) ? prev.filter(o => o !== office) : [...prev, office];
          return allOffices.filter(o => next.includes(o)); // preserve alphabetical order
        });
      };
      
      // Use real today's date
      const today = useMemo(() => new Date(), []);

      // Show weekend rows only if today is Saturday or Sunday
      const showWeekends = useMemo(() => {
        const dow = today.getDay();
        return dow === 0 || dow === 6;
      }, [today]);
      
      const [theme, setTheme] = useState(() => {
        if (typeof window !== 'undefined' && window.matchMedia) {
          return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }
        return 'dark';
      });

      // Apply theme class to document root for CSS custom properties
      useEffect(() => {
        if (theme === 'light') {
          document.documentElement.classList.add('light');
        } else {
          document.documentElement.classList.remove('light');
        }
      }, [theme]);

      useEffect(() => {
        if (typeof window === 'undefined' || !window.matchMedia) return;

        const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
        const handleChange = (e) => setTheme(e.matches ? 'dark' : 'light');

        mediaQuery.addEventListener('change', handleChange);
        return () => mediaQuery.removeEventListener('change', handleChange);
      }, []);

      const { weeks, currentSprint, quarterProgress } = useMemo(() => {
        const startDate = new Date(Date.UTC(2026, 0, 1));
        const endDate = new Date(Date.UTC(2026, 11, 31));
        
        const dayMap = new Map();
        sprintData.forEach(s => {
          const [startYear, startMonth, startDay] = s.start.split('-').map(Number);
          const [endYear, endMonth, endDay] = s.end.split('-').map(Number);
          const start = new Date(Date.UTC(startYear, startMonth - 1, startDay));
          const end = new Date(Date.UTC(endYear, endMonth - 1, endDay));
          
          for (let d = new Date(start); d <= end; d.setUTCDate(d.getUTCDate() + 1)) {
            const key = `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;
            dayMap.set(key, s);
          }
        });
        
        const todayStr = `${today.getUTCFullYear()}-${String(today.getUTCMonth() + 1).padStart(2, '0')}-${String(today.getUTCDate()).padStart(2, '0')}`;
        const currentSprint = dayMap.get(todayStr) || null;
        
        let quarterProgress = null;
        if (currentSprint) {
          const q = currentSprint.quarter;
          const quarterSprints = sprintData.filter(s => s.quarter === q);
          const currentIdx = quarterSprints.findIndex(s => s.sprint === currentSprint.sprint);
          
          const [qsYear, qsMonth, qsDay] = quarterSprints[0].start.split('-').map(Number);
          const [qeYear, qeMonth, qeDay] = quarterSprints[quarterSprints.length - 1].end.split('-').map(Number);
          const quarterStart = new Date(Date.UTC(qsYear, qsMonth - 1, qsDay));
          const quarterEnd = new Date(Date.UTC(qeYear, qeMonth - 1, qeDay));
          
          const totalDays = Math.ceil((quarterEnd - quarterStart) / (1000 * 60 * 60 * 24));
          const daysPassed = Math.ceil((today - quarterStart) / (1000 * 60 * 60 * 24));
          const daysLeft = Math.ceil((quarterEnd - today) / (1000 * 60 * 60 * 24));
          
          const totalWorkingDays = countWorkingDays(quarterStart, quarterEnd);
          const workingDaysPassed = countWorkingDays(quarterStart, today < quarterEnd ? today : quarterEnd);
          const workingDaysLeft = countWorkingDays(today, quarterEnd);

          quarterProgress = {
            quarter: q,
            currentSprintNum: currentIdx + 1,
            totalSprints: quarterSprints.length,
            daysPassed: Math.max(0, daysPassed),
            daysLeft: Math.max(0, daysLeft),
            totalDays,
            totalWorkingDays,
            workingDaysPassed: Math.max(0, workingDaysPassed),
            workingDaysLeft: Math.max(0, workingDaysLeft),
            percentage: Math.min(100, Math.max(0, (daysPassed / totalDays) * 100))
          };
        }
        
        const weeks = [];
        let currentWeek = [];
        
        const firstDay = new Date(startDate);
        const dayOfWeek = firstDay.getUTCDay();
        const mondayOffset = dayOfWeek === 0 ? -6 : 1 - dayOfWeek;
        firstDay.setUTCDate(firstDay.getUTCDate() + mondayOffset);
        
        for (let d = new Date(firstDay); d <= endDate || currentWeek.length > 0; d.setUTCDate(d.getUTCDate() + 1)) {
          const dateStr = `${d.getUTCFullYear()}-${String(d.getUTCMonth() + 1).padStart(2, '0')}-${String(d.getUTCDate()).padStart(2, '0')}`;
          const isInYear = d >= startDate && d <= endDate;
          
          currentWeek.push({
            date: new Date(d),
            dateStr,
            sprint: isInYear ? dayMap.get(dateStr) : null,
            isInYear,
            isToday: dateStr === todayStr,
            dayOfWeek: d.getUTCDay(),
            month: d.getUTCMonth()
          });
          
          if (currentWeek.length === 7) {
            weeks.push(currentWeek);
            currentWeek = [];
            if (d > endDate) break;
          }
        }
        
        return { weeks, currentSprint, quarterProgress };
      }, [today]);

      // Find the day object for "today" — used as fallback for the selector legend
      const todayDay = useMemo(() => {
        for (const week of weeks) {
          for (const day of week) {
            if (day.isToday) return day;
          }
        }
        return null;
      }, [weeks]);

      // Returns a CSS background value (solid color or linear-gradient for holiday stripes)
      const getBackground = (day) => {
        if (!day.isInYear) return "transparent";

        // Weekends (Sat=6, Sun=0) are always grey — non-working days
        const dow = day.dayOfWeek;
        if (dow === 0 || dow === 6) return "var(--weekend-bg)";

        if (!day.sprint) return "var(--non-sprint-bg)";

        const colors = quarterColors[day.sprint.quarter];

        // Check if day is in the past (before today)
        const isPast = day.date < today && !day.isToday;

        // Past days should be dark grey
        if (isPast) return "var(--past-day-bg)";

        // Determine the base sprint color for this day
        let sprintColor;
        if (day.isToday) {
          sprintColor = colors.current;
        } else if (selectedSprint && day.sprint.sprint === selectedSprint) {
          // Use a lighter shade for selected sprint (shade 4 instead of current/900)
          const quarterSprints = sprintData.filter(s => s.quarter === day.sprint.quarter);
          const sprintIdx = quarterSprints.findIndex(s => s.sprint === day.sprint.sprint);
          sprintColor = colors.shades[Math.min(4, sprintIdx)] || colors.shades[4];
        } else {
          const quarterSprints = sprintData.filter(s => s.quarter === day.sprint.quarter);
          const sprintIdx = quarterSprints.findIndex(s => s.sprint === day.sprint.sprint);
          sprintColor = colors.shades[sprintIdx] || colors.shades[0];
        }

        // If no offices selected, return solid sprint color (no holiday overlay)
        if (selectedOffices.length === 0) return sprintColor;

        // Check holidays for selected offices
        const holidays = holidayMap[day.dateStr];
        const stripes = selectedOffices.map(office => {
          const isHoliday = holidays && holidays[office];
          return isHoliday ? 'var(--weekend-bg)' : sprintColor;
        });

        // If all stripes are the same color, return solid
        if (stripes.every(s => s === stripes[0])) return stripes[0];

        // Build horizontal gradient with N equal stripes
        const pct = 100 / stripes.length;
        const stops = stripes.map((color, i) =>
          `${color} ${(i * pct).toFixed(1)}% ${((i + 1) * pct).toFixed(1)}%`
        );
        return `linear-gradient(to bottom, ${stops.join(', ')})`;
      };

      // Helper: check if a day is a holiday for any selected office
      const isDayHoliday = (day) => {
        if (selectedOffices.length === 0) return false;
        const holidays = holidayMap[day.dateStr];
        if (!holidays) return false;
        return selectedOffices.some(office => holidays[office]);
      };

      // Helper: check if a day is a holiday for ALL selected offices
      const isDayFullHoliday = (day) => {
        if (selectedOffices.length === 0) return false;
        const holidays = holidayMap[day.dateStr];
        if (!holidays) return false;
        return selectedOffices.every(office => holidays[office]);
      };
      
      const getWeekSprintStart = (week) => {
        for (const day of week) {
          if (day.isInYear && day.sprint && day.dateStr === day.sprint.start) {
            return day.sprint;
          }
        }
        return null;
      };
      
      const formatDate = (date) => {
        return `${date.getUTCDate()} ${months[date.getUTCMonth()]} ${date.getUTCFullYear()}`;
      };

      const monthLabels = useMemo(() => {
        const labels = [];
        let lastMonth = -1;
        weeks.forEach((week, weekIdx) => {
          const firstDayInYear = week.find(d => d.isInYear);
          if (firstDayInYear && firstDayInYear.month !== lastMonth) {
            labels.push({ month: firstDayInYear.month, weekIdx });
            lastMonth = firstDayInYear.month;
          }
        });
        return labels;
      }, [weeks]);

      return (
        <div className="min-h-screen p-6" style={{ backgroundColor: 'var(--bg)', color: 'var(--text)' }}>
          <div className="max-w-full mx-auto">
            {/* Current Status Panel */}
            {quarterProgress && currentSprint && (
              <div
                className="rounded-xl p-4 mb-6"
                style={{ backgroundColor: 'var(--calendar-bg)', border: '1px solid var(--card-border)' }}
              >
                <div className="flex flex-wrap gap-6 items-center justify-between">
                  <div>
                    <div className="text-xs mb-1" style={{ color: 'var(--text-muted)' }}>Today</div>
                    <div className="text-lg font-bold">{formatDate(today)}</div>
                  </div>

                  <div>
                    <div className="text-xs mb-1" style={{ color: 'var(--text-muted)' }}>Current Sprint</div>
                    <div className="text-lg font-bold" style={{ color: quarterColors[currentSprint.quarter].shades[3] }}>
                      {currentSprint.sprint}
                    </div>
                  </div>

                  <div className="flex-1 min-w-48">
                    <div className="flex justify-between text-xs mb-1">
                      <span style={{ color: 'var(--text-muted)' }}>{quarterColors[quarterProgress.quarter].full}</span>
                      <span className="font-medium">{quarterProgress.percentage.toFixed(0)}%</span>
                    </div>
                    <div className="h-2 rounded-full overflow-hidden" style={{ backgroundColor: 'var(--progress-bg)' }}>
                      <div
                        className="h-full rounded-full transition-all duration-500"
                        style={{
                          width: `${quarterProgress.percentage}%`,
                          backgroundColor: quarterColors[quarterProgress.quarter].shades[3]
                        }}
                      />
                    </div>
                    <div className="flex justify-between text-xs mt-1" style={{ color: 'var(--text-dim)' }}>
                      <span>Sprint {quarterProgress.currentSprintNum} of {quarterProgress.totalSprints}</span>
                      <span
                        title={`Calendar: ${quarterProgress.daysPassed} of ${quarterProgress.totalDays} days (${quarterProgress.daysLeft} left)\nWorking: ${quarterProgress.workingDaysPassed} of ${quarterProgress.totalWorkingDays} days (${quarterProgress.workingDaysLeft} left)`}
                        style={{ cursor: 'help', borderBottom: '1px dotted var(--text-dim)' }}
                      >{quarterProgress.daysLeft} days left</span>
                    </div>
                  </div>
                </div>
              </div>
            )}
            
            {/* Legend */}
            <div className="flex flex-wrap gap-4 mb-4 text-sm items-center">
              {Object.entries(quarterColors).filter(([k]) => k !== 'none').map(([key, val]) => (
                <div key={key} className="flex items-center gap-2">
                  <div className="flex gap-0.5">
                    {val.shades.slice(0, 3).map((color, i) => (
                      <div
                        key={i}
                        className="rounded-sm"
                        style={{ width: CELL_SIZE, height: CELL_SIZE, backgroundColor: color }}
                      />
                    ))}
                  </div>
                  <span style={{ color: 'var(--text-muted)' }}>{val.full}</span>
                </div>
              ))}
              <div className="flex items-center gap-2">
                <div
                  className="rounded-sm"
                  style={{ width: CELL_SIZE, height: CELL_SIZE, backgroundColor: 'var(--past-day-bg)' }}
                />
                <span style={{ color: 'var(--text-muted)' }}>Past Days</span>
              </div>
              <div className="flex items-center gap-2">
                <div
                  className="rounded-sm"
                  style={{ width: CELL_SIZE, height: CELL_SIZE, backgroundColor: 'var(--non-sprint-bg)' }}
                />
                <span style={{ color: 'var(--text-muted)' }}>Out of Sprint</span>
              </div>

            </div>
            
            {/* Heatmap */}
            <div
              className="rounded-xl p-4 overflow-x-auto"
              style={{ backgroundColor: 'var(--calendar-bg)', border: '1px solid var(--card-border)' }}
            >
              <div className="flex justify-center">
                <div className="inline-flex gap-4 items-start">
                  {/* Office selector - sticky on left */}
                  <div style={{
                    position: 'sticky',
                    left: '16px',
                    zIndex: 10,
                    paddingRight: '24px',
                    alignSelf: 'stretch',
                    background: 'linear-gradient(to right, var(--calendar-bg) 0%, var(--calendar-bg) 85%, transparent 100%)'
                  }}>
                    {(() => {
                      const selectorSize = 4 * CELL_SIZE + 3 * CELL_GAP; // 70px square
                      // Reference day: hovered day > today
                      const refDay = (hoveredDay && hoveredDay.isInYear) ? hoveredDay : todayDay;
                      // Sprint color from reference day's sprint
                      const refSprint = refDay?.sprint
                        || (selectedSprint ? sprintData.find(s => s.sprint === selectedSprint) : null)
                        || currentSprint;
                      const selectorQuarter = refSprint?.quarter || 'Q1';
                      const selectorColors = quarterColors[selectorQuarter];
                      const selectorSprintIdx = refSprint
                        ? sprintData.filter(s => s.quarter === selectorQuarter).findIndex(s => s.sprint === refSprint.sprint)
                        : 3;
                      const selectorColor = selectorColors.shades[selectorSprintIdx >= 0 ? selectorSprintIdx : 3] || selectorColors.shades[3];
                      // Per-office stripe color based on holiday status of refDay
                      const getStripeColor = (office) => {
                        if (!refDay || !refDay.sprint || refDay.dayOfWeek === 0 || refDay.dayOfWeek === 6) {
                          return 'var(--weekend-bg)';
                        }
                        const holidays = holidayMap[refDay.dateStr];
                        const isHoliday = holidays && holidays[office];
                        return isHoliday ? 'var(--weekend-bg)' : selectorColor;
                      };
                      return (
                        <div className="flex flex-col">
                          <div className="text-xs mb-1" style={{ color: 'var(--text-dim)', paddingLeft: 2 }}>Holidays</div>
                          <div className="rounded flex flex-col cursor-pointer" style={{
                            width: selectorSize,
                            height: selectorSize,
                            overflow: 'hidden',
                            border: '1px solid var(--card-border)',
                            gap: 0,
                            backgroundColor: 'var(--calendar-bg)',
                          }}>
                            {allOffices.map(office => {
                              const isActive = selectedOffices.includes(office);
                              const stripeColor = getStripeColor(office);

                              // Determine background color based on state
                              let backgroundColor;
                              let textColor;
                              let textShadow = 'none';
                              let borderStyle = 'none';

                              if (!isActive) {
                                // Невыбранный — светло-серый, тусклый текст
                                backgroundColor = 'var(--weekend-bg)';
                                textColor = 'var(--text-dim)';
                              } else if (stripeColor === 'var(--weekend-bg)') {
                                // Выбранный но нерабочий (holiday/weekend) — темно-серый с тонкой рамкой
                                backgroundColor = 'var(--past-day-bg)';
                                textColor = 'var(--text-muted)';
                                borderStyle = 'inset 0 0 0 1px rgba(255, 255, 255, 0.1)';
                              } else {
                                // Выбранный и рабочий — цвет спринта
                                backgroundColor = stripeColor;
                                textColor = '#fff';
                                textShadow = '0 0 2px rgba(0,0,0,0.6)';
                              }

                              return (
                                <div
                                  key={office}
                                  className="flex items-center justify-center"
                                  style={{
                                    flex: 1,
                                    background: backgroundColor,
                                    opacity: 1,
                                    boxShadow: borderStyle,
                                    transition: 'background-color 0.3s ease-in-out, color 0.3s ease-in-out, box-shadow 0.3s ease-in-out',
                                  }}
                                  onClick={() => toggleOffice(office)}
                                >
                                  <span style={{
                                    fontSize: '9px',
                                    lineHeight: 1,
                                    color: textColor,
                                    textShadow: textShadow,
                                    userSelect: 'none',
                                    transition: 'color 0.3s ease-in-out, text-shadow 0.3s ease-in-out',
                                  }}>
                                    {officeFlags[office]} {officeLabels[office]}
                                  </span>
                                </div>
                              );
                            })}
                          </div>
                        </div>
                      );
                    })()}
                  </div>

                  {/* Calendar container */}
                  <div>
                    <div className="flex flex-col">
                      {/* Month labels */}
                      <div className="flex mb-1 items-end">
                        <div className="flex-shrink-0 mr-2" style={{ width: 28 }} />
                        <div className="flex">
                          {monthLabels.map(({ month, weekIdx }, i) => {
                            const nextWeekIdx = monthLabels[i + 1]?.weekIdx || weeks.length;
                            const width = (nextWeekIdx - weekIdx) * CELL_STEP;
                            return (
                              <div
                                key={month}
                                className="text-xs flex-shrink-0"
                                style={{ width: `${width}px`, color: 'var(--text-muted)' }}
                              >
                                {months[month]}
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* Weekday labels and grid */}
                      <div className="flex">
                        {/* Weekday labels */}
                        <div className="flex flex-col mr-2 text-xs flex-shrink-0" style={{ color: 'var(--text-muted)', gap: CELL_GAP }}>
                          {weekdays.map((day, i) => {
                            if (!showWeekends && i >= 5) return null;
                            return (
                              <div key={day} className="flex items-center justify-end pr-1" style={{ height: CELL_SIZE, width: 28 }}>
                                {day}
                              </div>
                            );
                          })}
                        </div>

                        {/* Weeks grid */}
                        <div className="flex" style={{ gap: CELL_GAP }}>
                          {weeks.map((week, weekIdx) => {
                            return (
                              <Fragment key={weekIdx}>
                                <div className="flex flex-col" style={{ gap: CELL_GAP }}>
                                  {week.map((day, dayIdx) => {
                                    if (!showWeekends && dayIdx >= 5) return null;
                                    return (
                                      <div
                                        key={dayIdx}
                                        className={`rounded-sm cursor-pointer transition-all duration-150 ${day.isToday ? 'today-cell' : ''}`}
                                        style={{
                                          width: CELL_SIZE,
                                          height: CELL_SIZE,
                                          background: getBackground(day),
                                          opacity: day.isInYear ? 1 : 0,
                                          boxShadow: !day.isToday && selectedSprint && day.sprint?.sprint === selectedSprint
                                              && day.dayOfWeek !== 0 && day.dayOfWeek !== 6
                                              && !isDayFullHoliday(day)
                                            ? '0 0 0 1px var(--text-muted)'
                                            : 'none',
                                        }}
                                        onMouseEnter={() => setHoveredDay(day)}
                                        onMouseLeave={() => setHoveredDay(null)}
                                        onClick={() => {
                                          if (day.sprint) {
                                            setSelectedSprint(selectedSprint === day.sprint.sprint ? null : day.sprint.sprint);
                                          }
                                        }}
                                      />
                                    );
                                  })}
                                </div>
                              </Fragment>
                            );
                          })}
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* Tooltip */}
            {hoveredDay && hoveredDay.isInYear && (
              <div
                className="fixed bottom-6 left-1/2 -translate-x-1/2 rounded-lg px-4 py-3 shadow-xl z-50"
                style={{
                  backgroundColor: 'var(--calendar-bg)',
                  border: '1px solid var(--card-border)',
                  minWidth: '240px',
                  minHeight: '120px'
                }}
              >
                <div className="font-medium">{formatDate(hoveredDay.date)}</div>
                {hoveredDay.sprint ? (
                  <div className="text-sm" style={{ color: (() => {
                    const qc = quarterColors[hoveredDay.sprint.quarter];
                    const idx = sprintData.filter(s => s.quarter === hoveredDay.sprint.quarter).findIndex(s => s.sprint === hoveredDay.sprint.sprint);
                    return qc.shades[idx >= 0 ? idx : 3];
                  })() }}>
                    {hoveredDay.sprint.sprint} • {weekdays[hoveredDay.dayOfWeek === 0 ? 6 : hoveredDay.dayOfWeek - 1]}
                  </div>
                ) : (
                  <div className="text-sm" style={{ color: 'var(--text-muted)' }}>Out of Sprint</div>
                )}
                {hoveredDay.isToday && (
                  <div className="text-xs mt-1" style={{ color: quarterColors.Q3.shades[3] }}>← Today</div>
                )}
                {hoveredDay.dayOfWeek !== 0 && hoveredDay.dayOfWeek !== 6 && (
                  <div className="mt-1.5 text-xs" style={{ borderTop: '1px solid var(--card-border)', paddingTop: '6px' }}>
                    {allOffices.map(office => {
                      const holidays = holidayMap[hoveredDay.dateStr];
                      const isHoliday = holidays && holidays[office];
                      return (
                        <div key={office} className="flex justify-between gap-4" style={{ lineHeight: '1.7' }}>
                          <span style={{ color: 'var(--text-muted)' }}>{officeFlags[office]} {officeLabels[office]}</span>
                          <span style={{ color: isHoliday ? 'var(--text-dim)' : 'var(--text-muted)' }}>
                            {isHoliday ? 'Holiday' : 'Working'}
                          </span>
                        </div>
                      );
                    })}
                  </div>
                )}
              </div>
            )}
            
            {/* Sprint List - 4 columns */}
            <div className="mt-6 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
              {['Q1', 'Q2', 'Q3', 'Q4'].map(quarter => (
                <div
                  key={quarter}
                  className="rounded-lg p-3"
                  style={{ backgroundColor: 'var(--calendar-bg)', border: '1px solid var(--card-border)' }}
                >
                  <h3
                    className="font-bold mb-2 pb-2 text-sm"
                    style={{ color: quarterColors[quarter].shades[3], borderBottom: '1px solid var(--card-border)' }}
                  >
                    {quarterColors[quarter].full}
                  </h3>
                  <div className="space-y-1">
                    {sprintData.filter(s => s.quarter === quarter).map(sprint => {
                      const isCurrentSprint = currentSprint?.sprint === sprint.sprint;
                      return (
                        <div
                          key={sprint.sprint}
                          className="text-xs p-1.5 rounded cursor-pointer"
                          style={{
                            backgroundColor: isCurrentSprint || selectedSprint === sprint.sprint ? 'var(--hover-bg)' : 'transparent',
                          }}
                          onMouseEnter={(e) => { if (!isCurrentSprint && selectedSprint !== sprint.sprint) e.currentTarget.style.backgroundColor = 'var(--hover-bg)'; }}
                          onMouseLeave={(e) => { if (!isCurrentSprint && selectedSprint !== sprint.sprint) e.currentTarget.style.backgroundColor = 'transparent'; }}
                          onClick={() => setSelectedSprint(sprint.sprint === selectedSprint ? null : sprint.sprint)}
                        >
                          <div className="flex justify-between items-center">
                            <span className="font-medium">{sprint.sprint}</span>
                            {isCurrentSprint && (
                              <span
                                className="text-xs px-1.5 py-0.5 rounded-full"
                                style={{ backgroundColor: 'var(--progress-bg)' }}
                              >●</span>
                            )}
                          </div>
                          <div style={{ color: 'var(--text-muted)' }} className="mt-0.5">
                            {new Date(sprint.start + 'T00:00:00Z').getUTCDate()} {months[new Date(sprint.start + 'T00:00:00Z').getUTCMonth()]} — {new Date(sprint.end + 'T00:00:00Z').getUTCDate()} {months[new Date(sprint.end + 'T00:00:00Z').getUTCMonth()]}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>

            {/* Footer */}
            <div className="mt-8 text-center text-xs" style={{ color: 'var(--text-dim)' }}>
              TradingView Sprint Calendar • 2026
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<SprintHeatmap />);
  </script>
</body>
</html>
